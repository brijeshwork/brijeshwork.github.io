<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Subscription Billing System Design | Recurring Payments & State Machines</title>
  <meta name="description"
    content="Architecting a Billing System: Managing Subscription Life-cycles with State Machines, Handling Webhook Idempotency, Dunning strategies, and PCI Compliance (Tokenization).">
  <meta name="keywords"
    content="system design, billing system, subscription architecture, recurring payments, stripe webhooks, idempotency, pci compliance, dunning, finite state machine">
  <meta name="author" content="Brijesh Patel">
  <link rel="canonical" href="https://brijesh.work/system-design/subscription-billing/" />

  <!-- Styles -->
  <link rel="stylesheet" href="https://brijesh.work/pub/css/bootstrap.css">
  <link rel="stylesheet" href="https://brijesh.work/pub/css/style-main.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <script src="https://brijesh.work/pub/js/global.js" crossorigin="anonymous"></script>

  <style>
    /* Shared System Design Theme */
    .hero-section {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      /* Emerald Green */
      color: white;
      padding: 4rem 0;
      margin-bottom: 2rem;
      border-bottom: 4px solid #34d399;
    }

    .hero-subtitle {
      color: #d1fae5;
      font-size: 1.25rem;
    }

    .sidebar-sticky {
      position: sticky;
      top: 2rem;
    }

    .sidebar-toc .nav-link {
      color: #64748b;
      padding: 0.25rem 0;
      font-size: 0.95rem;
    }

    .sidebar-toc .nav-link:hover,
    .sidebar-toc .nav-link.active {
      color: #047857;
      font-weight: 500;
    }

    .content-section {
      margin-bottom: 3rem;
    }

    .tech-card {
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 1.5rem;
      height: 100%;
      background: #f8fafc;
      transition: transform 0.2s;
    }

    .tech-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .comparison-table th {
      background-color: #ecfdf5;
    }

    .badge-soft {
      background-color: rgba(16, 185, 129, 0.1);
      color: #059669;
      padding: 0.5em 0.8em;
    }

    .fsm-diagram {
      background: #ffffff;
      border: 2px dashed #34d399;
      border-radius: 0.5rem;
      padding: 2rem;
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .state-box {
      border: 2px solid #059669;
      padding: 10px 20px;
      display: inline-block;
      margin: 10px;
      background: #fff;
      border-radius: 20px;
      font-weight: bold;
      color: #065f46;
    }

    .arrow {
      font-size: 1.5rem;
      color: #10b981;
      vertical-align: middle;
      margin: 0 10px;
    }

    @media (max-width: 991px) {
      .order-lg-1 {
        order: 2;
      }

      .order-lg-2 {
        order: 1;
      }
    }
  </style>
</head>

<body class="bg-white">

  <header loadhtml="https://brijesh.work/pub/inc/header.html" class="header border-bottom"></header>

  <!-- Hero Section -->
  <section class="hero-section">
    <div class="container">
      <div class="row">
        <div class="col-lg-8">
          <span
            class="badge badge-soft mb-3 rounded-pill bg-light bg-opacity-10 text-white border border-white border-opacity-25">FinTech
            Architecture</span>
          <h1 class="display-4 fw-bold mb-3">Subscription Billing System</h1>
          <p class="hero-subtitle mb-4">Handling money at scale: Finite State Machines for invoicing, Idempotent
            Webhooks, and safe PCI-Compliant payment flows.</p>
          <div class="d-flex gap-3">
            <a href="#state-machine" class="btn btn-light text-success fw-bold"
              style="color: #047857 !important;">Lifecycle FSM</a>
            <a href="#idempotency" class="btn btn-outline-light">Idempotency</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="container pb-5">
    <div class="row">

      <!-- Main Content -->
      <main class="col-lg-9 order-lg-2">

        <!-- Introduction -->
        <section id="intro" class="content-section">
          <h2>Data Model: User vs Customer</h2>
          <p class="lead text-secondary">Never mix Auth data with Billing data. Keep them loosely coupled.</p>

          <div class="row">
            <div class="col-md-6 mb-3">
              <div class="tech-card border-top border-3 border-success">
                <h5 class="fw-bold">ðŸ”‘ User Table (App DB)</h5>
                <ul class="small text-muted mb-0">
                  <li><code>user_id</code> (UUID)</li>
                  <li><code>email</code></li>
                  <li><code>stripe_customer_id</code> (Foreign Key)</li>
                </ul>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="tech-card border-top border-3 border-primary">
                <h5 class="fw-bold">ðŸ’³ Payment Gateway (Stripe)</h5>
                <ul class="small text-muted mb-0">
                  <li><code>Customer</code> object</li>
                  <li><code>PaymentMethods</code> (Tokens)</li>
                  <li><code>Subscriptions</code></li>
                </ul>
              </div>
            </div>
          </div>
        </section>

        <!-- State Machine -->
        <section id="state-machine" class="content-section">
          <h2>Subscription Lifecycle (State Machine)</h2>
          <p>Billing logic is complex. Model it as a <strong>Finite State Machine (FSM)</strong> to handle transitions
            deterministically.</p>

          <div class="fsm-diagram d-none d-md-block">
            <div class="state-box">Trialing</div>
            <span class="arrow">â†’</span>
            <div class="state-box bg-success text-white">Active (Paid)</div>
            <br>
            <span class="arrow" style="transform: rotate(90deg); display: inline-block;">â¬‡</span> Payment Fails
            <br>
            <div class="state-box border-warning text-warning">Past Due</div>
            <span class="arrow">â†’</span>
            <div class="state-box bg-secondary text-white">Canceled</div>
            <span class="arrow">OR</span>
            <div class="state-box border-secondary text-muted">Unpaid</div>
          </div>

          <div class="mt-3">
            <ul>
              <li><strong>Active:</strong> Payment successful. Grant feature access.</li>
              <li><strong>Past Due:</strong> Payment failed (insufficient funds). Enter <strong>Dunning</strong> (retry
                logic). Do NOT revoke access yet.</li>
              <li><strong>Canceled/Unpaid:</strong> Retries exhausted (e.g., after 14 days). Revoke access.</li>
            </ul>
          </div>
        </section>

        <!-- Idempotency -->
        <section id="idempotency" class="content-section">
          <h2>Idempotency & Webhooks</h2>
          <p>Payment gateways send webhooks (e.g., <code>invoice.paid</code>) asynchronously. Network issues can cause
            duplicate events. Your handler MUST be <strong>Idempotent</strong>.</p>

          <div class="alert alert-warning border border-warning">
            <strong>Rule:</strong> Never process the same payment event twice. It could result in double provisioning or
            false analytics.
          </div>

          <pre><code class="language-python"># Python (Flask) Example: Handling Stripe Webhooks safely
import stripe
from flask import Flask, request, jsonify

@app.route('/webhook', methods=['POST'])
def stripe_webhook():
    payload = request.data
    sig_header = request.headers['Stripe-Signature']
    event = None

    try:
        # 1. Verify Signature (Security)
        event = stripe.Webhook.construct_event(payload, sig_header, endpoint_secret)
    except ValueError:
        return 'Invalid payload', 400

    # 2. Idempotency Check (Redis/DB)
    event_id = event['id']
    if redis.exists(f"processed_event:{event_id}"):
        return jsonify({'status': 'ignored - duplicate'}), 200

    # 3. Process Event based on Type
    if event['type'] == 'invoice.payment_succeeded':
        handle_payment_success(event['data']['object'])
    
    # 4. Mark as Processed (TTL 24h)
    redis.set(f"processed_event:{event_id}", "true", ex=86400)
    
    return jsonify({'status': 'success'}), 200</code></pre>
        </section>

        <!-- PCI Compliance -->
        <section id="pci" class="content-section">
          <h2>PCI Compliance (SAQ A)</h2>
          <p><strong>Never</strong> let raw Credit Card numbers touch your servers. If they hit your API logs, you are
            liable.</p>

          <table class="table table-bordered comparison-table">
            <tr>
              <th width="30%">Concept</th>
              <th>Best Practice</th>
            </tr>
            <tr>
              <td><strong>Tokenization</strong></td>
              <td>Frontend sends Card Data directly to Stripe (Stripe.js). Stripe returns a safe <code>token</code>
                (e.g., `tok_123`). Your backend only saves the token.</td>
            </tr>
            <tr>
              <td><strong>Stripe Elements</strong></td>
              <td>Using hosted inputs in `iframe` ensures card data never touches your DOM, reducing compliance scope to
                SAQ A (the easiest level).</td>
            </tr>
          </table>
        </section>

        <section class="content-section border-top pt-5">
          <h2>Summary</h2>
          <ul>
            <li><strong>State Machines:</strong> Essential for managing subscription status (`active`, `past_due`,
              `canceled`).</li>
            <li><strong>Dunning:</strong> Automation for recovering failed payments (smart retries).</li>
            <li><strong>Idempotency:</strong> Treat every webhook as if it could be delivered 5 times.</li>
            <li><strong>Compliance:</strong> Offload all sensitive data handling to the Payment Processor
              (Tokenization).</li>
          </ul>
        </section>

      </main>

      <!-- Sidebar -->
      <aside class="col-lg-3 order-lg-1 mb-4">
        <div class="sidebar-sticky">
          <h6 class="fw-bold text-uppercase text-secondary mb-3 small tracking-wide">On this page</h6>
          <nav class="nav flex-column sidebar-toc">
            <a class="nav-link" href="#intro">Data Model</a>
            <a class="nav-link" href="#state-machine">Lifecycle FSM</a>
            <a class="nav-link" href="#idempotency">Idempotency & Webhooks</a>
            <a class="nav-link" href="#pci">PCI Compliance</a>
          </nav>

          <hr class="my-4">
          <h6 class="fw-bold text-secondary mb-3 small">Related Topics</h6>
          <ul class="list-unstyled small">
            <li class="mb-2"><a href="../order-payment/" class="text-decoration-none text-muted">Order & Payment</a>
            </li>
            <li class="mb-2"><a href="../jwt-authentication/" class="text-decoration-none text-muted">Authentication</a>
            </li>
            <li class="mb-2"><a href="../event-driven-architecture/"
                class="text-decoration-none text-muted">Event-Driven Arch</a></li>
          </ul>
        </div>
      </aside>

    </div>
  </div>

  <footer loadhtml="https://brijesh.work/pub/inc/footer.html"></footer>
  <script src="https://brijesh.work/pub/js/footer.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script>includeHTML();</script>
</body>

</html>